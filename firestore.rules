/**
 * This ruleset enforces a secure, backend-managed data model for the TigerBeetle Pilot application.
 *
 * Core Philosophy:
 * The primary security posture is "default-deny" for all client-side (mobile/web app) access.
 * Data collections are protected, and access is granted only to authenticated users based on
 * the principle of least privilege.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Placeholder for administrative or backend-only access.
     * By default, this returns false. When admin roles are implemented,
     * this function should be updated (e.g., using custom claims).
     */
    function isBackendOrAdmin() {
      // return request.auth.token.admin == true;
      return false;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages TigerBeetle financial account data.
     * @path /tigerbeetle_accounts/{accountId}
     * @allow (read) - Authenticated users (operators) can read account data.
     * @allow (write) - Write access is restricted to backend/admin processes to ensure data integrity.
     */
    match /tigerbeetle_accounts/{accountId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isBackendOrAdmin();
      allow update: if isBackendOrAdmin();
      allow delete: if isBackendOrAdmin();

      /**
       * @description Manages transaction records for a specific TigerBeetle account.
       * @path /tigerbeetle_accounts/{accountId}/tigerbeetle_transactions/{transactionId}
       * @allow (read/write) - All access is restricted to backend services.
       */
      match /tigerbeetle_transactions/{transactionId} {
        allow read, write: if isBackendOrAdmin();
      }
    }

    /**
     * @description Stores system-wide configuration settings.
     * @path /configurations/{configId}
     * @allow (read/write) - Access is restricted to backend or administrative users.
     */
    match /configurations/{configId} {
      allow read, write: if isBackendOrAdmin();
    }

    /**
     * @description Stores audit and monitoring logs.
     * @path /log_entries/{logId}
     * @allow (read/write) - Access is restricted to backend services to ensure log integrity.
     */
    match /log_entries/{logId} {
      allow read, write: if isBackendOrAdmin();
    }
  }
}
