/**
 * This ruleset enforces a secure, backend-managed data model for the TigerBeetle Pilot application.
 *
 * Core Philosophy:
 * The primary security posture is "default-deny" for all client-side (mobile/web app) access.
 * Data collections are protected, and access is granted only to authenticated users based on
 * the principle of least privilege.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Placeholder for administrative or backend-only access.
     * For now, we allow any signed-in user to act as an operator.
     */
    function isOperator() {
      return isSignedIn();
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages TigerBeetle financial account data.
     */
    match /tigerbeetle_accounts/{accountId} {
      allow read: if isOperator();
      // In a real scenario, account creation and balance updates would be strictly backend-only.
      // For this simulation, we allow operators to create accounts and update balances.
      allow write: if isOperator();
    }

    /**
     * @description Manages sFIAT attestations.
     */
    match /attestations/{attestationId} {
        // Operators can read all attestations
        allow list, get: if isOperator();
        // Operators can create new attestations
        allow create: if isOperator();
        // Operators can update an attestation's status (e.g., to 'issued')
        allow update: if isOperator() && request.resource.data.status != resource.data.status;
    }
    
    /**
     * @description Immutable log of cleared transfers.
     */
    match /transfers/{transferId} {
        // Operators can read the history of transfers
        allow list, get: if isOperator();
        // Only operators (simulating the clearing service) can create a transfer record.
        allow create: if isOperator();
        // Transfers are immutable. No updates or deletes allowed.
        allow update, delete: if false;
    }


    /**
     * @description Stores system-wide configuration settings.
     * Access is restricted to backend or administrative users.
     */
    match /configurations/{configId} {
      allow read, write: if false; // Restricted to backend/admin
    }

    /**
     * @description Stores audit and monitoring logs.
     * Access is restricted to backend services to ensure log integrity.
     */
    match /log_entries/{logId} {
      allow read, write: if false; // Restricted to backend/admin
    }
  }
}
